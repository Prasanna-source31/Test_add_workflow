name: Add Workflow File to Repos

on:
  issues:
    type:
     -opened
     -closed
  schedule:
    - cron: '0 0 * * *'  # Run every day at midnight UTC

jobs:
  add_workflow:
    runs-on: ubuntu-latest

    steps:
      - name: Install GitHub CLI
        run: |
          sudo apt update
          sudo apt install -y software-properties-common
          sudo add-apt-repository ppa:deadsnakes/ppa -y
          sudo apt update
          sudo apt install -y python3-pip
          pip3 install gh
  
      - name: Retrieve Repository Names
        env:
          GH_TOKEN: ${{secrets.TEST_TOKEN}}
        run: |
          ORGANIZATION="Prasanna-source31"
          REPO_NAMES=$(curl -s -H "Authorization: Bearer $GH_TOKEN" "https://api.github.com/orgs/$ORGANIZATION/repos" | jq -r '.[].name')
          echo "Repository names: $REPO_NAMES"

      - name: Add Workflow File to Repos
        env:
          GH_TOKEN: ${{secrets.TEST_TOKEN}}
        run: |
          WORKFLOW_PATH=".github/workflows/terrascan.yml"  # Change this path if needed
          WORKFLOW_CONTENT=$(cat $WORKFLOW_PATH | base64 -w 0)
          
          for repo in $REPO_NAMES; do
            gh api -X PUT /repos/$ORGANIZATION/$repo/contents/$WORKFLOW_PATH \
              -F message="Add main workflow" \
              -F content="$WORKFLOW_CONTENT" \
              -F branch=main
            echo "Workflow file added to $repo"
          done
